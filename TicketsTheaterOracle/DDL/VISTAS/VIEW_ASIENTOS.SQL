CREATE MATERIALIZED VIEW MV_ASIENTOS
BUILD IMMEDIATE
REFRESH FAST ON COMMIT
AS
SELECT 
    (select teatro.nombre from teatro where teatro.id = funcion.teatro_id) AS TEATRO,
    tiq.HORARIO_FUNCION AS FUNCION,
    tiq.CLIENTE_DNI AS CLIENTE_DNI,
    ra.ASIENTO
FROM FUNCION_CARTELERA funcion
INNER JOIN TIQUETE tiq
    ON tiq.funcion_id = funcion.id
INNER JOIN RESERVA_ASIENTO ra
    ON ra.tiquete_id = tiq.id
WHERE funcion.en_cartelera = 'S';

CREATE MATERIALIZED VIEW MV_TIQUETES_BY_CLIENTE
BUILD IMMEDIATE
REFRESH FAST ON COMMIT
SELECT 
    pel.TITULO AS PELICULA,
    te.NOMBRE AS TEATRO,
    tiq.HORARIO_FUNCION,
    tiq.CLIENTE_DNI,
    cli.NOMBRE || ' ' || cli.APELLIDO AS CLIENTE,
    tiq.PRECIO AS PRECIO_UNITARIO,
    COUNT(ra.ASIENTO) AS CANTIDAD_ASIENTOS,
    COUNT(ra.ASIENTO) * tiq.PRECIO AS TOTAL_PAGADO,
    tiq.FECHA_COMPRA
FROM TIQUETE tiq
INNER JOIN CLIENTE cli
    ON cli.DNI = tiq.CLIENTE_DNI
INNER JOIN FUNCION_CARTELERA fc
    ON fc.ID = tiq.FUNCION_ID
INNER JOIN PELICULA pel
    ON pel.ID = fc.PELICULA_ID
INNER JOIN TEATRO te
    ON te.ID = fc.TEATRO_ID
INNER JOIN RESERVA_ASIENTO ra
    ON ra.TIQUETE_ID = tiq.ID
WHERE fc.EN_CARTELERA = 'S'
GROUP BY 
    te.NOMBRE, 
    pel.TITULO, 
    tiq.CLIENTE_DNI, 
    cli.NOMBRE, 
    cli.APELLIDO, 
    tiq.PRECIO,
    tiq.HORARIO_FUNCION,
    tiq.FECHA_COMPRA
ORDER BY 
    te.NOMBRE,
    TOTAL_PAGADO DESC;
